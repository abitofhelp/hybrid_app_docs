@startuml static_dispatch_go
!theme plain
skinparam linetype ortho

title Generic-Based Static Dispatch\nCompile-Time Binding in Go (Application)

package "Infrastructure Layer" #E6F3FF {
  class "console.Writer" as CW <<struct>> {
    +Write(ctx, msg) : Result[Unit]
    --
    Concrete implementation
    of output port
  }
}

package "Application Layer" #E8F5E9 {
  class "outbound.WriterPort" as Port <<interface constraint>> {
    +Write(ctx, msg) : Result[Unit]
    --
    **Type Constraint**
    Defines required behavior
    for generic parameter
  }

  class "usecase.GreetUseCase[W]" as UC <<generic struct>> {
    -writer : W
    +Execute(ctx, cmd) : Result[Unit]
    --
    **Generic Use Case**
    W constrained by WriterPort
    Concrete type known at compile time
  }
}

package "Presentation Layer" #FFE4E1 {
  class "cli.GreetCommand[G]" as CLI <<generic struct>> {
    -useCase : G
    +Run() : int
    --
    **Generic CLI Adapter**
    G constrained by GreetPort
  }
}

package "Bootstrap Layer" #FFEBCD {
  class "bootstrap.CLI" as Bootstrap <<composition root>> {
    +Run() : int
    --
    **Composition Root**
    Instantiates all generics
    with concrete types
  }
}

' Relationships
CW ..|> Port : satisfies constraint
UC o--> Port : type parameter W
CLI o--> UC : type parameter G
Bootstrap -down-> CW : instantiates with
Bootstrap -down-> UC : instantiates
Bootstrap -down-> CLI : instantiates

note right of Bootstrap #CCFFCC
  **bootstrap/cli Wiring**
  ═══════════════════════════════════

  ```go
  // Located in: bootstrap/cli/
  // bootstrap.go

  package cli

  import (
      "github.com/.../infrastructure/adapter/console"
      "github.com/.../application/usecase"
      "github.com/.../presentation/adapter/cli"
  )

  // Concrete types for generic instantiation
  type (
      writerImpl   = *console.Writer
      useCaseImpl  = *usecase.GreetUseCase[writerImpl]
  )

  func Run() int {
      // Create infrastructure
      writer := console.NewWriter()

      // Instantiate generic use case
      greetUC := usecase.NewGreetUseCase[writerImpl](writer)

      // Instantiate generic CLI command
      greetCmd := cli.NewGreetCommand[useCaseImpl](greetUC)

      // Execute
      return greetCmd.Run()
  }
  ```

  **Key:** Type aliases make generic
  instantiation chains readable
end note

note bottom of UC
  **Generic Use Case Definition**
  ═══════════════════════════════════

  ```go
  package usecase

  // W is constrained by WriterPort interface
  type GreetUseCase[W outbound.WriterPort] struct {
      writer W
  }

  func NewGreetUseCase[W outbound.WriterPort](
      w W,
  ) *GreetUseCase[W] {
      return &GreetUseCase[W]{writer: w}
  }

  func (uc *GreetUseCase[W]) Execute(
      ctx context.Context,
      cmd command.GreetCommand,
  ) domerr.Result[model.Unit] {
      // Validate and create Person
      personResult := valueobject.CreatePerson(cmd.Name())
      if personResult.IsErr() {
          return domerr.Err[model.Unit](personResult.Error())
      }

      // Format and write greeting
      // uc.writer.Write is statically dispatched
      msg := fmt.Sprintf("Hello, %s!", personResult.Value().Name())
      return uc.writer.Write(ctx, msg)
  }
  ```
end note

note bottom of Port
  **Interface as Type Constraint**
  ═══════════════════════════════════

  ```go
  package outbound

  // WriterPort serves as type constraint
  // for generic parameters
  type WriterPort interface {
      Write(ctx context.Context, msg string)
          domerr.Result[model.Unit]
  }
  ```

  **Key:** Interface used as constraint,
  not for dynamic dispatch
end note

legend right
  **Go Generic Static Dispatch**
  ═══════════════════════════════════════

  **Three Go Dispatch Mechanisms:**
  1. **Static (direct)** - No indirection
  2. **Static (generic)** - Compile-time bound ✓
  3. **Dynamic (interface)** - Runtime vtable

  **Why Generics for Static Dispatch:**
  • Concrete type known at compile time
  • No interface indirection overhead
  • Compiler can inline method calls
  • Type safety preserved

  **Comparison to Ada:**
  ═══════════════════════════════════════
  Ada: generic with procedure Write(...)
  Go:  type GreetUseCase[W WriterPort]

  Ada: package My_UC is new Use_Case(Write)
  Go:  NewGreetUseCase[*console.Writer](w)

  **Application Architecture**
  ═══════════════════════════════════════
  • bootstrap: Generic instantiation root
  • presentation: Generic CLI adapters
  • application: Generic business logic
  • infrastructure: Concrete implementations
  • domain: Pure business rules
endlegend

@enduml
