@startuml error_handling_flow
!theme plain

title Error Handling Flow\nRailway-Oriented Programming with Generic_Result

actor User

participant "Presentation\nGreet_Command" as Presentation #FFE4E1
participant "Application\nGreet_Use_Case" as Application #E8F5E9
participant "Infrastructure\nConsole_Writer" as Infrastructure #E6F3FF
participant "Domain\nGeneric_Result" as Domain #FFF9E6

== Happy Path (Success) ==

User -> Presentation : ./greeter Alice
activate Presentation

Presentation -> Presentation : Create Command record
note right
  ```ada
  Cmd : Greet_Command.Command :=
    (Name => To_Unbounded_String ("Alice"));
  ```
end note

Presentation -> Application : Use_Case.Execute(Cmd)\n[STATIC DISPATCH]
activate Application

Application -> Application : Person.Create(Name)
note right
  Domain validation
  Returns Result (Person)
end note

Application -> Infrastructure : Console_Write(Message)\n[STATIC DISPATCH]
activate Infrastructure

Infrastructure -> Infrastructure : Put_Line(Message)
note right
  **Exception Handling**
  begin/exception block
  Catches I/O exceptions
  Transforms to Result
end note

Infrastructure --> Application : Result.Ok(Unit_Value)
deactivate Infrastructure

Application --> Presentation : Result.Ok(Unit_Value)
deactivate Application

Presentation -> Presentation : Result.Is_Ok = True
Presentation --> User : Exit code 0
deactivate Presentation

== Error Path (Infrastructure Failure) ==

User -> Presentation : ./greeter Bob
activate Presentation

Presentation -> Application : Use_Case.Execute(Cmd)
activate Application

Application -> Infrastructure : Console_Write(Message)
activate Infrastructure

Infrastructure -> Infrastructure : Put_Line raises\nexception
note right #FFCCCC
  **Exception Boundary**
  begin/exception catches
  I/O errors mapped to Result
end note

Infrastructure -> Domain : Result.Err(\n  New_Infrastructure_Error(\n    "write failed: ..."))
activate Domain

Domain --> Infrastructure : Error(Infrastructure_Error)
deactivate Domain

Infrastructure --> Application : Error(Infrastructure_Error)
deactivate Infrastructure

Application --> Presentation : Error(Infrastructure_Error)
deactivate Application

Presentation -> Presentation : Result.Is_Error = True
Presentation -> Presentation : Extract Error_Info
note right
  ```ada
  Err : Error_Type := Result.Error_Value;
  -- Err.Kind, Err.Message
  ```
end note

Presentation -> Presentation : Pattern match Error_Kind
note right
  ```ada
  case Err.Kind is
     when Infrastructure_Error =>
        Put_Line (Standard_Error,
          "A system error occurred.");
  end case;
  ```
end note

Presentation --> User : "Error: write failed: ..."\nExit code 1
deactivate Presentation

== Error Path (Domain Validation) ==

User -> Presentation : ./greeter ""
activate Presentation

Presentation -> Application : Use_Case.Execute(Cmd)
activate Application

Application -> Domain : Person.Create("")
activate Domain

Domain -> Domain : Validate name\n(Length > 0)
note right #FFCCCC
  **Domain Validation**
  Pure function check
  No exceptions
  Returns Error variant
end note

Domain --> Application : Error(Validation_Error)
deactivate Domain

Application --> Presentation : Error(Validation_Error)
deactivate Application

Presentation -> Presentation : Extract Error_Info
Presentation -> Presentation : Pattern match
note right
  ```ada
  case Err.Kind is
     when Validation_Error =>
        Put_Line (Standard_Error,
          "Please provide a valid name.");
  end case;
  ```
end note

Presentation --> User : "Error: name cannot be empty"\nExit code 1
deactivate Presentation

legend right
  **Error Handling Rules**
  ════════════════════════════════════
  1. **Domain**: Validates, returns Error variant
  2. **Application**: Orchestrates, propagates errors
  3. **Infrastructure**: Catches exceptions via
     begin/exception, converts to Error
  4. **Presentation**: Pattern matches errors,
     displays user-friendly messages

  **Key Patterns**
  ════════════════════════════════════
  • Generic_Result (not Ada exceptions)
  • Exception handling at infrastructure boundary
  • Application.Error for Presentation
  • Domain.Error for Infrastructure
  • Railway-oriented programming

  **Static Dispatch**
  ════════════════════════════════════
  • All calls resolved at compile time
  • Zero runtime overhead (no dispatching)
  • Type safety verified by compiler
endlegend

@enduml
